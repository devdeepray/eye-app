<!DOCTYPE html>
<html>
    <script type="text/javascript">
        var callibrationSize = 0
        var imgwidthconv = 1.0
        var correctcount = 0
        var wrongcount = 0
        var imgDir = ""
        var level = 2
        var currenteye = "left"
        var leftscore = 0
        var rightscore = 0
        var correctsincewrong = 0

        function onLoad() {
            callibrationSize = 0
            imgwidthconv = 1.0
            correctcount = 0
            wrongcount = 0
            imgDir = ""
            level = 2
            correctsincewrong = 0
            currenteye = "left"
            leftscore = 0
            rightscore = 0
            document.getElementById("content").innerHTML = document.getElementById("landing").innerHTML
        }

        function levelToImgSize(level) {
            mmwidth = 0
            if (level == 1) {
                mmwidth = 58.2
            } else if (level == 2) {
                mmwidth = 29.1
            } else if (level == 3) {
                mmwidth = 18.4
            } else if (level == 4) {
                mmwidth = 14.61
            } else if (level == 5) {
                mmwidth = 11.61
            } else if (level == 6) {
                mmwidth = 9.22
            } else if (level == 7) {
                mmwidth = 7.32
            } else if (level == 8) {
                mmwidth = 5.82
            } else if (level == 9) {
                mmwidth = 4.62
            }
            return Math.floor(mmwidth * imgwidthconv)
        }

        function insertAndExecute(id, text) {
            document.getElementById(id).innerHTML = text;
            var scripts = Array.prototype.slice.call(document.getElementById(id).getElementsByTagName("script"));
            for (var i = 0; i < scripts.length; i++) {
                if (scripts[i].src != "") {
                    var tag = document.createElement("script");
                    tag.src = scripts[i].src;
                    document.getElementsByTagName("head")[0].appendChild(tag);
                }
                else {
                    eval(scripts[i].innerHTML);
                }
            }
        }

        function onCallibrated() {
            callibrationSize = document.getElementById("callibrationSize").value
            // 800px is calibration chart. 24 divisions. Per division: 800 / 24
            // Credit card size is 85.6mm.
            // mm to pixel conversion: (mm) * (800 / 24) * (callibrationSize / 85.6)
            imgwidthconv = (800.0 / 24.0) * (callibrationSize / 85.6)
            insertAndExecute("content", document.getElementById("modeselection").innerHTML)
        }

        function hotvSelection() {
            imgdir = "hotv"
            startingTest()
        }

        function picsSelection() {
            imgdir = "pics"
            startingTest()
        }

        function startingTest() {
            insertAndExecute("content", document.getElementById("startingtest").innerHTML)
            othereye = "left"
            if (currenteye == "left") {
                othereye = "right"
            }
            document.getElementById("testeye").innerHTML = "<h1>Starting the test for the " + currenteye + " eye. <br>Please cover the " + othereye + " with a patch. </h1>"
        }

        function startTest() {
            level = 2
            correctcount = 0
            wrongcount = 0

            insertAndExecute("content", document.getElementById("testing").innerHTML)
            document.getElementById("testeye").innerHTML =  "Testing " + currenteye + " eye."
            nextImage()
        }

        function nextImage() {
            document.getElementById("testimage").innerHTML = "<img src=" + imgdir + "/image" + (Math.floor(Math.random() * 4) + 1).toString() + ".png width=" + levelToImgSize(level) + "px>"
        }

        function endOrNextTest() {
            if (currenteye == "left") {
                leftscore = level
                currenteye = "right"
                startingTest()
            } else {
                rightscore = level
                endTest()
            }
        }

        function levelToVision(l) {
            if (l == 1) {
                return 200
            } else if (l == 2) {
                return 100
            } else if (l == 3) {
                return 70
            } else if (l == 4) {
                return 50
            } else if (l == 5) {
                return 40
            } else if (l == 6) {
                return 30
            } else if (l == 7) {
                return 25
            } else if (l == 8) {
                return 20
            } else {
                return 15
            }
        }

        function endTest() {
            // Print results.
            insertAndExecute("content", document.getElementById("result").innerHTML)
            document.getElementById("leftresult").innerHTML = "20/" + levelToVision(leftscore).toString()
            document.getElementById("rightresult").innerHTML = "20/" + levelToVision(rightscore).toString()
        }

        function correctChoice() {
            correctcount = correctcount + 1
            correctsincewrong = correctsincewrong + 1

            if (correctsincewrong == 6) {
                wrongcount = 0
                correctcount = 0
                level = level + 1
            } else if (correctcount == 3) {
                correctcount = 0
                level = level + 1
            }

            if (level > 9) {
                level = 9
                endOrNextTest()
                return
            }

            nextImage()
        }

        function unreliableTest() {
            insertAndExecute("content", document.getElementById("unreliabletest").innerHTML)
        }

        function wrongChoice() {
            wrongcount = wrongcount + 1
            if (wrongcount == 1) {
                level = level - 1
                correctcount = 0
                correctsincewrong = 0
            } else if (wrongcount == 2) {
                if (correctsincewrong < 3) {
                    unreliableTest()
                    return
                } else {
                    endOrNextTest()
                    return
                }
            } else if (wrongcount > 2) {
                unreliableTest()
                return
            }

            if (level == 0) {
                unreliableTest()
                return
            }

            nextImage()
        }
    </script>
    <template id="modeselection">
        <div>
            <h1>
                Mode selection
            </h1>
            <p>
                Select pictures or text for testing.
            </p>
            <div style="width:600px">
                <div style="width:250px; display: inline-block; float left;">
                    <img src="media/selectorhotv.png" alt="HOTV selection" width=100%>
                    <form onsubmit="hotvSelection()">
                    <input type="submit">
                    </form>
                </div>
                <div style="width: 250px; display: inline-block; float:right;">
                    <img src="media/selectorpics.png" alt="Pictures selection" width=100%>
                    <form onsubmit="picsSelection()">
                    <input type="submit">
                    </form>
                </div>
            </div>
        </div>
    </template>

    <template id="landing">
        <div>
            <h1>
                Eye test
            </h1>
            <p>
            Measure the long edge of a credit card by placing one of it's short edge aligned to the left of the callibration scale and
            note the nearest marker from the right edge of the credit card.
            If the size measured from the callibration scale is too small (less than 5), please zoom out for a valid callibration.
            </p><br>
            <img src="media/callibration.svg" alt="Callibration chart" width=800px> <br>
        
            Enter the callibration number from the callibration scale in the box below:<br>
            <form onsubmit="onCallibrated()">
            <input type="number" min="5" max="24" value="5" step="1" id="callibrationSize" required>
            <br><br>
            <input type="submit">
            </form>
        </div>
    </template>

    <template id="testing">
        <div id="testimage">

        </div>
        <form>
            <input type="button" value="Correct" onclick="correctChoice()">
            <input type="button" value="Wrong" onclick="wrongChoice()">
        </form>
        <div id="testeye">
            
        </div>
    </template>

    <template id="result">
        <h1>
            Left eye result:
        </h1> <br>
        <div id="leftresult"></div> <br>
        <h1>
            Right eye result:
        </h1> <br>
        <div id="rightresult"></div> <br>
    </template>

    <template id="unreliabletest">
        <h1>
            The test is unreliable. Please try again.
        </h1>
        <form>
            <input type="button" value="Try again" onclick="onLoad()">
        </form>
    </template>

    <template id="startingtest">
        
        <h2>Important: Instructions</h2>
        <ul>
            <li>
                Keep the device 4 meters from the child. Please measure with tape as approximating this might result in inaccuracies.
            </li>
            <li>
                Have the childâ€™s wear his glasses unless doctor specifically asked to test without them.
            </li>
            <li>
                Create an eye patch for the child to cover the eye not being tested. Ensure the child is not peeking.
            </li>
            <li>
                Increase device screen brightness to maximum.
            </li>
        </ul>

        <br>
        <div id="testeye"></div>
        <br>
        
        <form>
            <input type="button" value="Continue" onclick="startTest()">
        </form>
    </template>



    <body onload="onLoad()">

    <div id="content">
    </div>
    </body>
</html>